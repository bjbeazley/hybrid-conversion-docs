name: Build LaTeX PDFs

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    # One build at a time per ref (branch or PR merge ref)
    concurrency:
      group: build-${{ github.ref }}
      cancel-in-progress: true

    # Run inside a container that already has TeX Live + latexmk installed
    container: ghcr.io/schnatterer/texlive-full:latest

    steps:
      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          apt-get update -yq
          apt-get install -yq rsync

      - name: Check out repository
        uses: actions/checkout@v4

      - name: Build LaTeX files from manifest
        shell: bash
        run: |
          set -euo pipefail

          manifest="latex_build_manifest.txt"
          if [ ! -f "$manifest" ]; then
            echo "ERROR: Missing manifest: $manifest"
            exit 1
          fi

          # Read manifest:
          # - strip CR (Windows)
          # - remove comments
          # - drop empty lines
          mapfile -t TEX_FILES < <(
            sed 's/\r$//' "$manifest" \
              | sed 's/#.*$//' \
              | awk 'NF { print }'
          )

          if [ "${#TEX_FILES[@]}" -eq 0 ]; then
            echo "ERROR: Manifest contains no build targets."
            exit 1
          fi

          for tex in "${TEX_FILES[@]}"; do
            if [ ! -f "$tex" ]; then
              echo "ERROR: Listed file not found: $tex"
              exit 1
            fi

            dir="$(dirname "$tex")"
            file="$(basename "$tex")"

            echo "Building: $tex"
            ( cd "$dir" && latexmk -pdf -interaction=nonstopmode -halt-on-error "$file" )
          done

      - name: Stage PDFs for GitHub Pages (preserve docs/ tree)
        shell: bash
        run: |
          set -euo pipefail

          if [ -e site ]; then
            echo "ERROR: 'site/' already exists. Refusing to overwrite."
            exit 1
          fi

          mkdir -p site/docs

          # Copy only PDFs, preserving directory structure under docs/
          rsync -av \
            --include='*/' \
            --include='*.pdf' \
            --exclude='*' \
            docs/ site/docs/

          # Disable Jekyll processing
          touch site/.nojekyll

      - name: Generate landing page (index.html)
        shell: bash
        run: |
          set -euo pipefail

          {
            echo '<!doctype html>'
            echo '<html>'
            echo '<head>'
            echo '  <meta charset="utf-8">'
            echo '  <meta name="viewport" content="width=device-width, initial-scale=1">'
            echo '  <title>Documents</title>'
            echo '</head>'
            echo '<body>'
            echo '  <h1>Documents</h1>'
            echo '  <ul>'

            # List PDFs relative to site root
            (cd site && find docs -type f -name '*.pdf' | sort) | while read -r pdf; do
              echo "    <li><a href=\"${pdf}\">${pdf}</a></li>"
            done

            echo '  </ul>'
            echo '</body>'
            echo '</html>'
          } > site/index.html

      # On pull requests, upload the built PDFs as an artifact so reviewers can download them
      - name: Upload PDFs as pull request artifact
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: pdfs
          path: site/docs

      # Only prepare a Pages artifact on pushes to main or manual workflow runs on main
      - name: Upload Pages artifact
        if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-slim

    # Only deploy Pages on pushes to main or manual workflow runs (never on PRs)
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')

    # Only one deploy at a time, repo-wide
    concurrency:
      group: deploy-pages
      cancel-in-progress: true

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
